<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Madani Exp Tracker (Cloud)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 1s ease-in-out; }
        .is-today { border-color: #0d9488 !important; background-color: #f0fdfa !important; color: #0f766e !important; font-weight: 800; }
        #auth-container, #app-container { display: none; } /* Initially hidden */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #0d9488; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 bg-slate-50 min-h-screen flex flex-col">

    <!-- === AUTH CONTAINER (Login/Signup) === -->
    <div id="auth-container" class="w-full max-w-md mx-auto min-h-screen flex flex-col justify-center px-6 bg-white fade-in">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-teal-100 shadow-md">
                <i class="fas fa-cloud-upload-alt text-3xl text-teal-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-800">Madani Tracker</h1>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Secure Cloud Sync</p>
        </div>

        <div class="space-y-4" id="login-form">
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Email Address</label>
                <input type="email" id="auth-email" placeholder="name@example.com" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-teal-500 transition-colors">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Password</label>
                <input type="password" id="auth-pass" placeholder="••••••••" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-teal-500 transition-colors">
            </div>
            
            <p id="auth-error" class="text-center text-red-500 text-xs font-bold hidden"></p>

            <button onclick="handleLogin()" id="btn-login" class="w-full bg-teal-600 text-white py-3.5 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">Log In</button>
            <button onclick="handleSignup()" id="btn-signup" class="w-full bg-white text-teal-600 border border-teal-100 py-3.5 rounded-xl font-bold shadow-sm active:scale-95 transition-transform">Create Account</button>
        </div>

        <!-- Offline Fallback Message -->
        <div id="offline-msg" class="hidden text-center mt-6 p-4 bg-orange-50 rounded-xl border border-orange-100">
            <p class="text-xs text-orange-600 font-bold mb-2">⚠️ Cloud Service Unavailable</p>
            <button onclick="startGuestMode()" class="text-[10px] bg-orange-200 text-orange-800 px-3 py-1 rounded-lg font-bold">Use Offline Mode</button>
        </div>
        
        <p class="text-center text-[10px] text-slate-300 mt-8">Your data is safe on the cloud.</p>
    </div>

    <!-- === MAIN APP CONTAINER (After Login) === -->
    <div id="app-container" class="w-full max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl overflow-hidden pb-[90px] fade-in">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-teal-700 flex items-center gap-2"><i class="fas fa-wallet"></i> Madani Tracker</h1>
                <p class="text-[9px] text-slate-400 font-bold ml-7 -mt-1 tracking-wide truncate max-w-[120px]" id="user-email-display">User</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold" id="net-worth-label">Net Worth</p>
                    <h2 class="text-xl font-bold text-slate-800" id="total-balance">₹0</h2>
                </div>
                <button onclick="handleLogout()" class="w-8 h-8 rounded-full bg-red-50 text-red-400 hover:bg-red-100 flex items-center justify-center active:scale-90" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <!-- === 1. HOME VIEW === -->
        <section id="view-home" class="p-4 block pb-24">
            <div class="flex bg-slate-200 p-1 rounded-lg mb-4">
                <button onclick="setHomeFilter('daily')" id="hf-daily" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Daily</button>
                <button onclick="setHomeFilter('monthly')" id="hf-monthly" class="flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-teal-700">Monthly</button>
                <button onclick="setHomeFilter('yearly')" id="hf-yearly" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Yearly</button>
            </div>

            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center"><p class="text-[10px] text-slate-500 uppercase font-bold">Cash</p><p class="text-sm font-bold text-slate-800" id="cash-balance">...</p></div>
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center"><p class="text-[10px] text-slate-500 uppercase font-bold">Bank</p><p class="text-sm font-bold text-slate-800" id="bank-balance">...</p></div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-center relative"><p class="text-[10px] text-slate-500 uppercase font-bold">Udhar</p><p class="text-sm font-bold text-orange-600" id="udhar-balance">...</p></div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div onclick="showSummary('income')" class="cursor-pointer bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center active:scale-95 transition-transform"><div><p class="text-[10px] text-emerald-600 font-bold uppercase" id="lbl-inc">Income</p><p class="text-lg font-bold text-emerald-700" id="total-income">₹0</p></div><div class="bg-emerald-200/50 w-8 h-8 rounded-full flex items-center justify-center text-emerald-700"><i class="fas fa-arrow-down"></i></div></div>
                <div onclick="showSummary('expense')" class="cursor-pointer bg-rose-50 p-4 rounded-xl border border-rose-100 flex justify-between items-center active:scale-95 transition-transform"><div><p class="text-[10px] text-rose-600 font-bold uppercase" id="lbl-exp">Expense</p><p class="text-lg font-bold text-rose-700" id="total-expense">₹0</p></div><div class="bg-rose-200/50 w-8 h-8 rounded-full flex items-center justify-center text-rose-700"><i class="fas fa-arrow-up"></i></div></div>
            </div>

            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 mb-4">
                <div class="flex justify-center mb-6 relative">
                    <div class="h-48 w-48 relative z-10"><canvas id="expenseChart"></canvas></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><p class="text-[10px] text-slate-400 uppercase font-bold">Total</p><p class="text-lg font-bold text-slate-800" id="chart-total-center">₹0</p></div>
                </div>
                <div id="analysis-legend" class="space-y-3"></div>
            </div>
        </section>

        <!-- === 2. REPORT VIEW === -->
        <section id="view-report" class="p-4 hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Reports & History</h2>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                <div class="flex gap-2 mb-3">
                    <select id="filter-type" class="w-1/3 p-2 text-xs rounded-lg border border-slate-300"><option value="month">Monthly</option><option value="year">Yearly</option><option value="custom">Custom</option><option value="all">All Time</option></select>
                    <input type="month" id="filter-month-input" class="w-2/3 p-2 text-xs rounded-lg border border-slate-300">
                    <select id="filter-year-input" class="hidden w-2/3 p-2 text-xs rounded-lg border border-slate-300"></select>
                </div>
                <div id="custom-date-range" class="hidden flex gap-2 mb-3"><input type="date" id="filter-start-date" class="w-1/2 p-2 text-xs rounded-lg border border-slate-300"><input type="date" id="filter-end-date" class="w-1/2 p-2 text-xs rounded-lg border border-slate-300"></div>
                <div class="flex bg-slate-200 p-1 rounded-lg">
                    <button onclick="setReportFilter('all')" id="btn-rep-all" class="flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800">All</button>
                    <button onclick="setReportFilter('expense')" id="btn-rep-exp" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Debit</button>
                    <button onclick="setReportFilter('income')" id="btn-rep-inc" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Credit</button>
                </div>
            </div>
            <button onclick="downloadPDF()" class="w-full mb-4 bg-slate-800 text-white py-2.5 rounded-lg text-xs font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95"><i class="fas fa-file-pdf"></i> Download PDF</button>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><ul id="full-list" class="divide-y divide-slate-50"></ul></div>
        </section>

        <!-- === 3. BUDGET VIEW === -->
        <section id="view-budget" class="p-4 hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Budget Plan (50/30/20)</h2>
            <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 mb-6">
                <div class="flex justify-between items-center mb-1">
                    <label class="text-[10px] font-bold text-teal-700 uppercase">Monthly Salary</label>
                    <span class="text-[10px] bg-teal-100 text-teal-700 px-2 py-0.5 rounded font-bold" id="auto-salary-badge" style="display:none;">Auto</span>
                </div>
                <div class="mb-4"><h1 class="text-3xl font-bold text-teal-800" id="budget-salary-display">₹0</h1></div>
                <div class="grid grid-cols-3 gap-2 text-center text-[10px]">
                    <div class="bg-white p-2 rounded-lg border border-blue-100"><p class="text-blue-600 font-bold mb-1">Needs 50%</p><p id="rule-50-val" class="font-black text-slate-700">₹0</p></div>
                    <div class="bg-white p-2 rounded-lg border border-purple-100"><p class="text-purple-600 font-bold mb-1">Wants 30%</p><p id="rule-30-val" class="font-black text-slate-700">₹0</p></div>
                    <div class="bg-white p-2 rounded-lg border border-emerald-100"><p class="text-emerald-600 font-bold mb-1">Save 20%</p><p id="rule-20-val" class="font-black text-slate-700">₹0</p></div>
                </div>
            </div>
            <div id="budget-groups" class="space-y-6">
                <div><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-blue-600">Needs</h3><span id="needs-limit-text" class="text-[10px] font-bold text-slate-400"></span></div><div class="space-y-3" id="list-needs"></div></div>
                <div><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-purple-600">Wants</h3><span id="wants-limit-text" class="text-[10px] font-bold text-slate-400"></span></div><div class="space-y-3" id="list-wants"></div></div>
                <div><div class="flex justify-between items-center mb-2"><h3 class="text-sm font-bold text-emerald-600">Savings</h3><span id="savings-limit-text" class="text-[10px] font-bold text-slate-400"></span></div><div class="space-y-3" id="list-savings"></div></div>
            </div>
        </section>

        <!-- === 4. UDHAR VIEW === -->
        <section id="view-udhar" class="p-4 hidden pb-24">
            <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-slate-800">Udhar Manager</h2></div>
            <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 mb-4 text-center">
                <p class="text-xs text-orange-800 uppercase font-bold tracking-wider mb-1">Total Market Balance</p>
                <h1 class="text-3xl font-bold text-orange-600" id="udhar-total-display">₹0</h1>
                <button onclick="openNewUdharModal()" class="mt-4 w-full bg-orange-600 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:scale-95 shadow-md"><i class="fas fa-exchange-alt"></i> Naya Udhar</button>
            </div>
            <h3 class="font-bold text-slate-700 text-sm mb-3">Accounts</h3>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden" id="udhar-list-container"></div>
            <p id="no-udhar-msg" class="text-center text-slate-400 text-xs py-10 hidden">No active accounts.</p>
        </section>

        <!-- NAV -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 flex justify-between items-end px-6 pb-2 pt-2 z-40 shadow-lg" style="left: 50%; transform: translateX(-50%);">
            <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1" id="nav-home"><i class="fas fa-home text-lg"></i><span class="text-[9px] font-bold">Home</span></button>
            <button onclick="switchView('report')" class="nav-item flex flex-col items-center gap-1" id="nav-report"><i class="fas fa-chart-pie text-lg"></i><span class="text-[9px] font-bold">Report</span></button>
            <div class="relative w-12 flex justify-center z-50"><button onclick="openEntryModal()" class="absolute -top-10 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl fab-shadow transition-transform active:scale-90 border-[4px] border-slate-50 shadow-lg shadow-teal-100"><i class="fas fa-plus"></i></button></div>
            <button onclick="switchView('budget')" class="nav-item flex flex-col items-center gap-1" id="nav-budget"><i class="fas fa-wallet text-lg"></i><span class="text-[9px] font-bold">Budget</span></button>
            <button onclick="switchView('udhar')" class="nav-item flex flex-col items-center gap-1" id="nav-udhar"><i class="fas fa-hand-holding-usd text-lg"></i><span class="text-[9px] font-bold">Udhar</span></button>
        </nav>
    </div>

    <!-- ENTRY MODAL -->
    <div id="entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="entry-modal-title">New Entry</h3><button onclick="closeEntryModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4"><div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs" id="type-tabs-wrapper"><button onclick="setTxType('expense')" id="btn-expense" class="flex-1 py-3 rounded-lg shadow-sm bg-white text-rose-600">Expense</button><button onclick="setTxType('income')" id="btn-income" class="flex-1 py-3 rounded-lg text-slate-400">Income</button></div><input type="hidden" id="tx-type" value="expense"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="tx-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-teal-500"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Category</label><select id="tx-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"></select></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Wallet</label><select id="tx-account" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Date</label><input type="date" id="tx-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none" onchange="checkToday(this.id)"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Note</label><input type="text" id="tx-note" placeholder="Details..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none"></div></div><button onclick="saveTransaction()" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-check"></i> <span id="save-btn-text">Save Transaction</span></button></div></div></div>

    <!-- UDHAR MODAL -->
    <div id="udhar-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="udhar-modal-title">New Udhar Entry</h3><button onclick="closeUdharModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4"><div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs mb-3"><button onclick="setUdharType('given')" id="btn-u-given" class="flex-1 py-3 rounded-lg shadow-sm bg-white text-orange-600">Maine Diya</button><button onclick="setUdharType('taken')" id="btn-u-taken" class="flex-1 py-3 rounded-lg text-slate-400">Maine Liya</button></div><input type="hidden" id="udhar-type-val" value="given"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="udhar-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-orange-500"></div><button onclick="pickContact()" class="w-full py-3 bg-orange-50 border border-dashed border-orange-200 rounded-xl text-orange-600 font-bold text-xs flex items-center justify-center gap-2 hover:bg-orange-100"><i class="fas fa-address-book text-lg"></i> Select from Contacts</button><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Person Name</label><input type="text" id="udhar-person" list="udhar-names-list" placeholder="Enter Name" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"><datalist id="udhar-names-list"></datalist></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Mobile</label><input type="tel" id="udhar-phone" placeholder="91..." class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"></div><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1" id="wallet-label">From Wallet</label><select id="udhar-source" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Date</label><input type="date" id="udhar-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-xs font-semibold text-slate-700 outline-none" onchange="checkToday(this.id)"></div><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Due Date</label><input type="date" id="udhar-return-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-xs font-semibold text-slate-700 outline-none"></div></div><button onclick="saveUdharTransaction()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-orange-700 active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-save"></i> <span id="save-udhar-btn-text">Save Loan</span></button></div></div></div>

    <!-- UTILITY MODALS -->
    <div id="summary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-lg text-slate-800" id="summary-title">Summary</h3><button onclick="document.getElementById('summary-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div id="summary-content" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar"></div></div></div>
    
    <!-- WUSOOL MODAL -->
    <div id="wusool-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-50 pb-2"><h3 class="font-bold text-lg text-slate-800" id="wusool-modal-title">Receive Money</h3><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><p class="text-xs text-slate-500 mb-2 font-bold" id="wusool-msg">Settling...</p><input type="hidden" id="wusool-person-name"><label class="block text-[10px] font-bold text-emerald-600 uppercase mb-2 ml-1">Received Amount</label><div class="flex gap-2 mb-3"><input type="number" id="wusool-amount" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-lg font-bold text-slate-800 focus:outline-none focus:border-teal-500"><button onclick="settleFull()" class="bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap active:scale-95">Full</button></div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Deposit To</label><select id="wusool-account" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold mb-4"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select><div class="flex gap-2"><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="flex-1 py-2 text-slate-500 font-bold text-xs bg-slate-100 rounded-lg">Cancel</button><button onclick="confirmWusool()" class="flex-1 py-2 text-white font-bold text-xs bg-emerald-600 rounded-lg">Confirm</button></div></div></div>
    
    <!-- PERSON HISTORY MODAL (ACTION CENTER) -->
    <div id="person-history-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="flex justify-between items-center p-4 pb-2 border-b border-slate-50 shrink-0"><div><h3 class="font-bold text-lg text-slate-800" id="ph-name">Name</h3><p class="text-[10px] text-slate-400">Transaction History</p></div><button onclick="document.getElementById('person-history-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="bg-slate-50 p-4 text-center border-b border-slate-100"><h2 id="ph-balance" class="text-3xl font-bold text-slate-800 mb-1">₹0</h2><p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Current Balance</p></div><div class="grid grid-cols-3 gap-2 p-4 pb-0"><button id="btn-give-more" class="bg-rose-50 hover:bg-rose-100 border border-rose-100 text-rose-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-minus-circle text-lg"></i> <span class="text-xs font-bold">Give</span></button><button id="btn-receive-money" class="bg-emerald-50 hover:bg-emerald-100 border border-emerald-100 text-emerald-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-plus-circle text-lg"></i> <span class="text-xs font-bold">Receive</span></button><button id="btn-settle-all" class="bg-blue-50 hover:bg-blue-100 border border-blue-100 text-blue-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-check-circle text-lg"></i> <span class="text-xs font-bold">Settle</span></button></div><div class="px-4 pt-2"><button id="btn-whatsapp" class="w-full py-2.5 bg-green-50 text-green-700 border border-green-100 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:scale-95 hover:bg-green-100 transition-colors"><i class="fab fa-whatsapp text-lg"></i> Send Reminder</button></div><div class="p-4 pt-4 overflow-y-auto space-y-4 flex-1" id="ph-content"></div></div></div>
    
    <div id="contacts-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-800">Select Contact</h3><button onclick="document.getElementById('contacts-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div><div id="contacts-list-content" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div></div></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Safe Config Loader
        let firebaseConfig = null;
        let app, auth, db;
        let isCloudAvailable = false;

        try {
            // Attempt to get variable safely
            let rawConfig = null;
            try { rawConfig = __firebase_config; } catch(e) {}
            
            // Validate JSON format
            if (rawConfig && typeof rawConfig === 'string' && rawConfig.trim().startsWith('{')) {
                firebaseConfig = JSON.parse(rawConfig);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isCloudAvailable = true;
            } else {
                console.warn("Valid Firebase config not found. Mode: Offline/Guest.");
            }
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
        }

        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default-app';

        let currentUser = null;
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgetSalary = parseFloat(localStorage.getItem('budgetSalary')) || 0;
        let categoryBudgets = JSON.parse(localStorage.getItem('categoryBudgets')) || {};
        let chartInstance = null;
        let homeFilter = 'monthly';
        let filterState = { type: 'month', month: new Date().toISOString().slice(0,7), year: new Date().getFullYear(), start: '', end: '', reportFilter: 'all' };

        // Expose functions globally for HTML onClick
        window.handleLogin = async () => {
            if(!isCloudAvailable) return alert("Cloud service is unavailable. Please check configuration.");
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errEl = document.getElementById('auth-error');
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                errEl.classList.add('hidden');
            } catch (error) {
                errEl.innerText = error.message;
                errEl.classList.remove('hidden');
            }
        };

        window.handleSignup = async () => {
            if(!isCloudAvailable) return alert("Cloud service is unavailable.");
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errEl = document.getElementById('auth-error');
            try {
                await createUserWithEmailAndPassword(auth, email, pass);
                errEl.classList.add('hidden');
            } catch (error) {
                errEl.innerText = error.message;
                errEl.classList.remove('hidden');
            }
        };

        window.handleLogout = () => {
            if(isCloudAvailable) signOut(auth);
            else location.reload(); // Simple reload for offline logout
        };

        window.startGuestMode = () => {
             document.getElementById('auth-container').style.display = 'none';
             document.getElementById('app-container').style.display = 'block';
             document.getElementById('user-email-display').innerText = "Guest Mode";
             initAppData(true); // true = offline mode
        };

        // Auth Listener
        if(isCloudAvailable) {
            onAuthStateChanged(auth, (user) => {
                const authDiv = document.getElementById('auth-container');
                const appDiv = document.getElementById('app-container');
                if (user) {
                    currentUser = user;
                    authDiv.style.display = 'none';
                    appDiv.style.display = 'block';
                    document.getElementById('user-email-display').innerText = user.email;
                    initAppData(false);
                } else {
                    currentUser = null;
                    authDiv.style.display = 'flex';
                    appDiv.style.display = 'none';
                }
            });
        } else {
            // Show offline msg on auth screen
            document.getElementById('offline-msg').classList.remove('hidden');
            document.getElementById('login-form').classList.add('opacity-50', 'pointer-events-none');
        }

        // --- Categories Config ---
        const catConfig = {
            "Food & Groceries": { icon: "fa-utensils", color: "bg-orange-500", text: "text-orange-500", type: "needs" },
            "Utilities": { icon: "fa-bolt", color: "bg-blue-500", text: "text-blue-500", type: "needs" },
            "Mobile & Recharge": { icon: "fa-mobile-alt", color: "bg-cyan-500", text: "text-cyan-500", type: "needs" },
            "Transportation": { icon: "fa-bus", color: "bg-yellow-500", text: "text-yellow-500", type: "needs" },
            "Medical & Health": { icon: "fa-briefcase-medical", color: "bg-green-500", text: "text-green-500", type: "needs" },
            "EMI / Loan": { icon: "fa-university", color: "bg-red-600", text: "text-red-600", type: "needs" },
            "Repair & Maintenance": { icon: "fa-tools", color: "bg-gray-500", text: "text-gray-500", type: "needs" },
            "Shopping": { icon: "fa-shopping-bag", color: "bg-purple-500", text: "text-purple-500", type: "wants" },
            "Personal Care": { icon: "fa-user-circle", color: "bg-pink-400", text: "text-pink-400", type: "wants" },
            "Family Shopping": { icon: "fa-shopping-bag", color: "bg-purple-500", text: "text-purple-500", type: "wants" },
            "Eating Out": { icon: "fa-hamburger", color: "bg-rose-400", text: "text-rose-400", type: "wants" },
            "Travel & Tour": { icon: "fa-plane", color: "bg-sky-500", text: "text-sky-500", type: "wants" },
            "Family Support": { icon: "fa-users", color: "bg-indigo-500", text: "text-indigo-500", type: "savings" },
            "Donations & Charity": { icon: "fa-hand-holding-heart", color: "bg-teal-500", text: "text-teal-500", type: "savings" },
            "Savings & Investment": { icon: "fa-piggy-bank", color: "bg-emerald-600", text: "text-emerald-600", type: "savings" },
            "Unexpected / Emergency": { icon: "fa-exclamation-triangle", color: "bg-red-500", text: "text-red-500", type: "savings" },
            "Salary": { icon: "fa-money-bill", color: "bg-emerald-500", text: "text-emerald-500" },
            "Business": { icon: "fa-briefcase", color: "bg-blue-600", text: "text-blue-600" },
            "Gift": { icon: "fa-gift", color: "bg-pink-500", text: "text-pink-500" },
            "Bonus": { icon: "fa-star", color: "bg-yellow-500", text: "text-yellow-500" },
            "Loan Taken": { icon: "fa-hand-holding-usd", color: "bg-orange-500", text: "text-orange-500" },
            "Carry Forward": { icon: "fa-forward", color: "bg-gray-600", text: "text-gray-600" }
        };
        const expenseCats = Object.keys(catConfig).filter(k => !["Salary","Business","Gift","Bonus","Loan Taken","Carry Forward"].includes(k));
        const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        // --- CORE LOGIC ---
        function initAppData(offline = false) {
            if(!offline && isCloudAvailable && currentUser) {
                // Cloud Sync Listeners
                const txRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
                onSnapshot(txRef, (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                });
                const settingsRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'budget');
                onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) categoryBudgets = docSnap.data().categoryBudgets || {};
                    updateBudgetUI();
                });
            } else {
                // Local Storage (Guest)
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                categoryBudgets = JSON.parse(localStorage.getItem('categoryBudgets')) || {};
                updateUI();
            }
            setupDates();
            switchView('home');
        }

        // --- ACTION FUNCTIONS ---
        window.saveTransaction = async () => {
            const type = document.getElementById('tx-type').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value;
            const cat = document.getElementById('tx-category').value;
            const acc = document.getElementById('tx-account').value;

            if(!amount || amount <= 0) return alert("Enter valid amount");

            const entry = { date, amount, type, note, desc: cat, account: acc, createdAt: new Date().toISOString() };
            
            if (isCloudAvailable && currentUser) {
                try {
                    if (window.editingTransactionId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', window.editingTransactionId), entry);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), entry);
                    }
                } catch(e) { console.error(e); }
            } else {
                // Local
                if (window.editingTransactionId) {
                    const idx = transactions.findIndex(t => t.id === window.editingTransactionId);
                    if(idx !== -1) transactions[idx] = { ...transactions[idx], ...entry };
                } else {
                    entry.id = Date.now().toString();
                    transactions.push(entry);
                }
                saveLocal();
            }
            window.closeEntryModal();
        };

        window.saveUdharTransaction = async () => {
             const uType = document.getElementById('udhar-type-val').value; 
             const amount = parseFloat(document.getElementById('udhar-amount').value);
             const person = document.getElementById('udhar-person').value;
             const phone = document.getElementById('udhar-phone').value;
             const source = document.getElementById('udhar-source').value;
             const date = document.getElementById('udhar-date').value;
             const rDate = document.getElementById('udhar-return-date').value;

             if(!amount || amount <= 0) return alert("Enter amount");
             if(!person) return alert("Enter Name");

             const isLoanTaken = uType === 'taken';
             const type = isLoanTaken ? 'loan_taken' : 'udhar';
             const desc = isLoanTaken ? `Loan from ${person}` : `Loan to ${person}`;
             
             const entry = { date, amount, type, desc, person, phone, account: source, returnDate: rDate, isUdhar: true, note: '', createdAt: new Date().toISOString() };

             if (isCloudAvailable && currentUser) {
                 try {
                    if (window.editingTransactionId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', window.editingTransactionId), entry);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), entry);
                    }
                 } catch(e) { console.error(e); }
             } else {
                 if (window.editingTransactionId) {
                    const idx = transactions.findIndex(t => t.id === window.editingTransactionId);
                    if(idx !== -1) transactions[idx] = { ...transactions[idx], ...entry };
                 } else {
                    entry.id = Date.now().toString();
                    transactions.push(entry);
                 }
                 saveLocal();
             }
             
             window.closeUdharModal();
             if(window.lastOpenedPerson) window.openPersonDetails(window.lastOpenedPerson);
             
             // WhatsApp
             if(phone) {
                const cleanPhone = phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                const amountFormatted = formatter.format(amount).replace('₹', '').trim();
                let msg = "";
                if(isLoanTaken) {
                     msg = `Assalamualaikum ${person},%0AMaine aapse ₹${amountFormatted} udhar liye hain.%0AInshaAllah main ${rDate || 'jald'} tak wapas kar dunga.%0AShukriya.`;
                } else {
                     msg = `Salam ${person},%0AAap ne ₹${amountFormatted} udhaar liye hain.%0AWapas karne ki Date: ${rDate || 'Tay nahi hui'}%0AEntry save kar di gayi hai.`;
                }
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
             }
        };

        window.deleteTransaction = async (id) => {
            if(!confirm("Delete?")) return;
            if(isCloudAvailable && currentUser) {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id)); } catch(e) {}
            } else {
                transactions = transactions.filter(t => t.id !== id);
                saveLocal();
            }
            if(window.lastOpenedPerson) window.openPersonDetails(window.lastOpenedPerson);
        };

        window.setCategoryLimit = async (cat, val) => {
            const amount = parseFloat(val);
            if(amount >= 0) categoryBudgets[cat] = amount; else delete categoryBudgets[cat];
            
            if(isCloudAvailable && currentUser) {
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'budget'), { categoryBudgets }, { merge: true });
            } else {
                saveLocal();
            }
            updateBudgetUI();
        };

        function saveLocal() {
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('categoryBudgets', JSON.stringify(categoryBudgets));
            updateUI();
        }
        
        // --- UI UPDATERS (Unified) ---
        window.updateUI = () => {
             // ... existing recalculateRepayments ...
             transactions.forEach(t => { if(t.isUdhar) { t.repaid = 0; t.status = 'active'; }});
             const recoveries = transactions.filter(t => t.type === 'income' && t.desc && t.desc.startsWith('Recovery:'));
             const recoveriesByPerson = {};
             recoveries.forEach(r => { const name = r.desc.replace('Recovery: ', ''); if(!recoveriesByPerson[name]) recoveriesByPerson[name] = []; recoveriesByPerson[name].push(r); });
             for(const person in recoveriesByPerson) {
                 // Sort by date (use createdAt if avail, else date)
                 const loans = transactions.filter(t => t.type === 'udhar' && t.person === person).sort((a,b) => (a.createdAt || a.date).localeCompare(b.createdAt || b.date));
                 let totalRecovered = recoveriesByPerson[person].reduce((sum, r) => sum + r.amount, 0);
                 for(const loan of loans) {
                     if(totalRecovered <= 0) break;
                     const allocation = Math.min(loan.amount, totalRecovered);
                     loan.repaid += allocation;
                     totalRecovered -= allocation;
                     if(loan.repaid >= loan.amount - 0.1) loan.status = 'settled';
                 }
             }

             // UI Calculations
             let cash = 0, bank = 0, udhar = 0, income = 0, expense = 0;
             const now = new Date();
             const currentMonth = now.toISOString().slice(0,7);
             const currentYear = now.getFullYear();
             const todayDate = now.toISOString().split('T')[0];
             let filteredIncome = 0; let filteredExpense = 0;

             transactions.forEach(t => {
                 // Global Balances (All Time)
                 if(t.type === 'income' || t.type === 'loan_taken') { t.account === 'Cash' ? cash += t.amount : bank += t.amount; }
                 if(t.type === 'expense' || t.type === 'udhar') { t.account === 'Cash' ? cash -= t.amount : bank -= t.amount; }
                 if(t.type === 'udhar') { 
                     const rem = t.amount - (t.repaid || 0); 
                     if(t.status === 'active' || rem > 0.1) udhar += rem; 
                 }
                 
                 // Filter Stats
                 let include = false;
                 if(homeFilter === 'monthly' && t.date.startsWith(currentMonth)) include = true;
                 else if(homeFilter === 'daily' && t.date === todayDate) include = true;
                 else if(homeFilter === 'yearly' && new Date(t.date).getFullYear() === currentYear) include = true;

                 if(include) {
                     if(t.type === 'income' || t.type === 'loan_taken') filteredIncome += t.amount;
                     if(t.type === 'expense' || t.type === 'udhar') filteredExpense += t.amount;
                     if(t.type === 'income' && !t.isWusool) income += t.amount;
                     if(t.type === 'expense') expense += t.amount;
                 }
             });

             document.getElementById('total-balance').innerText = formatter.format(filteredIncome - filteredExpense);
             document.getElementById('cash-balance').innerText = formatter.format(cash);
             document.getElementById('bank-balance').innerText = formatter.format(bank);
             document.getElementById('udhar-balance').innerText = formatter.format(udhar);
             document.getElementById('udhar-total-display').innerText = formatter.format(udhar);
             document.getElementById('total-income').innerText = formatter.format(income);
             document.getElementById('total-expense').innerText = formatter.format(expense);

             if(currentView === 'home') updateChart();
             if(currentView === 'report') renderFullList();
             if(currentView === 'udhar') renderCustomerList();
             if(currentView === 'budget') updateBudgetUI();
        };
        
        window.switchView = (view) => {
            ['home', 'report', 'udhar', 'settings', 'budget'].forEach(v => {
                const el = document.getElementById('view-'+v);
                if(el) el.classList.add('hidden');
                const nav = document.getElementById('nav-'+v);
                if(nav) { nav.classList.remove('active', 'text-teal-600'); if(v !== view) nav.classList.add('text-slate-300'); }
            });
            const target = document.getElementById('view-'+view);
            if(target) target.classList.remove('hidden');
            const targetNav = document.getElementById('nav-'+view);
            if(targetNav) { targetNav.classList.add('active', 'text-teal-600'); targetNav.classList.remove('text-slate-300'); }
            currentView = view;
            updateUI(); 
        };

        // --- HELPER FUNCTIONS ---
        window.setHomeFilter = (f) => { homeFilter = f; updateUI(); 
            document.getElementById('hf-daily').className = f==='daily' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-teal-700" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            document.getElementById('hf-monthly').className = f==='monthly' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-teal-700" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            document.getElementById('hf-yearly').className = f==='yearly' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-teal-700" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            const labels = {daily:'(Today)', monthly:'(Month)', yearly:'(Year)'};
            document.getElementById('lbl-inc').innerText = `Income ${labels[f]}`;
            document.getElementById('lbl-exp').innerText = `Expense ${labels[f]}`;
            document.getElementById('chart-label').innerText = labels[f];
            document.getElementById('net-worth-label').innerText = `Balance ${labels[f]}`;
        };

        window.setTodayDate = (id) => {
            const el = document.getElementById(id);
            el.value = new Date().toISOString().split('T')[0];
            checkToday(id);
        }

        window.checkToday = (id) => {
             const el = document.getElementById(id);
             const today = new Date().toISOString().split('T')[0];
             if(el.value === today) el.classList.add('is-today', 'ring-2', 'ring-teal-100', 'border-teal-500');
             else el.classList.remove('is-today', 'ring-2', 'ring-teal-100', 'border-teal-500');
        }
        
        window.setupDates = () => {
             const today = new Date().toISOString().split('T')[0];
             const inputs = ['tx-date', 'udhar-date'];
             inputs.forEach(id => {
                 const el = document.getElementById(id);
                 if(el) { el.value = today; checkToday(id); }
             });
             const select = document.getElementById('filter-year-input');
             if(select && select.children.length === 0) {
                 const yr = new Date().getFullYear();
                 for(let i=0; i<5; i++) { const opt = document.createElement('option'); opt.value = yr-i; opt.text = yr-i; select.appendChild(opt); }
             }
        };

        // --- UI Rendering Helpers ---
        window.updateBudgetUI = () => {
            const currentMonth = new Date().toISOString().slice(0,7);
            const salaryIncome = transactions.filter(t => t.type === 'income' && t.desc === 'Salary' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            
            budgetSalary = salaryIncome > 0 ? salaryIncome : 0;
            document.getElementById('auto-salary-badge').style.display = budgetSalary > 0 ? 'inline' : 'none';
            document.getElementById('budget-salary-display').innerText = formatter.format(budgetSalary);

            const containerNeeds = document.getElementById('list-needs');
            const containerWants = document.getElementById('list-wants');
            const containerSavings = document.getElementById('list-savings');
            
            if(budgetSalary <= 0) {
                 document.getElementById('rule-50-val').innerText = '₹0';
                 document.getElementById('rule-30-val').innerText = '₹0';
                 document.getElementById('rule-20-val').innerText = '₹0';
                 containerNeeds.innerHTML = '<p class="text-[10px] text-slate-400">Add Income (Salary) to see budget.</p>';
                 containerWants.innerHTML = '';
                 containerSavings.innerHTML = '';
                 return;
            }

            const limits = { needs: budgetSalary * 0.5, wants: budgetSalary * 0.3, savings: budgetSalary * 0.2 };
            document.getElementById('rule-50-val').innerText = `${formatter.format(limits.needs)} limit`;
            document.getElementById('rule-30-val').innerText = `${formatter.format(limits.wants)} limit`;
            document.getElementById('rule-20-val').innerText = `${formatter.format(limits.savings)} limit`;

            // Groups
            const groups = { needs: [], wants: [], savings: [] };
            expenseCats.forEach(cat => { if(catConfig[cat]) groups[catConfig[cat].type].push(cat); });

            const renderGroup = (type, listId, limitMax) => {
                 const container = document.getElementById(listId);
                 container.innerHTML = '';
                 let totalAllocated = 0;
                 groups[type].forEach(cat => {
                     const limit = categoryBudgets[cat] || 0;
                     totalAllocated += limit;
                     const spent = transactions.filter(t => t.type === 'expense' && t.desc === cat && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
                     const remaining = limit - spent;
                     const pct = limit > 0 ? (spent / limit) * 100 : 0;
                     let color = "bg-teal-500";
                     if(spent > limit && limit > 0) color = "bg-red-500"; else if(pct > 80) color = "bg-orange-500";

                     const div = document.createElement('div');
                     div.className = "bg-white p-3 rounded-xl border border-slate-100 shadow-sm";
                     div.innerHTML = `<div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><i class="fas ${catConfig[cat].icon} text-slate-400 text-xs"></i><span class="text-xs font-bold text-slate-700">${cat}</span></div><input type="number" placeholder="Limit" value="${limit > 0 ? limit : ''}" onchange="setCategoryLimit('${cat}', this.value)" class="w-16 p-1 text-[10px] border border-slate-200 rounded text-right font-bold bg-slate-50"></div><div class="w-full bg-slate-100 rounded-full h-1 mb-1 overflow-hidden"><div class="${color} h-1 rounded-full progress-bar" style="width: ${Math.min(pct, 100)}%"></div></div><div class="flex justify-between text-[9px] text-slate-400 font-semibold"><span>Spent: ${formatter.format(spent)}</span><span class="${remaining < 0 ? 'text-red-500 font-bold' : 'text-emerald-600'}">${limit > 0 ? 'Baqi: ' + formatter.format(remaining) : ''}</span></div>`;
                     container.appendChild(div);
                 });
                 const header = document.getElementById(`${type}-limit-text`);
                 header.innerText = `Plan: ${formatter.format(totalAllocated)} / Rule: ${formatter.format(limitMax)}`;
                 header.className = totalAllocated > limitMax ? "text-[10px] font-bold text-red-500" : "text-[10px] font-bold text-emerald-600";
            };

            renderGroup('needs', 'list-needs', limits.needs);
            renderGroup('wants', 'list-wants', limits.wants);
            renderGroup('savings', 'list-savings', limits.savings);
        };

        window.renderFullList = () => {
             const list = document.getElementById('full-list');
             list.innerHTML = '';
             let data = transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
             if(filterState.reportFilter === 'expense') data = data.filter(t => t.type === 'expense');
             if(filterState.reportFilter === 'income') data = data.filter(t => t.type === 'income');
             if(filterState.type === 'month') data = data.filter(t => t.date.startsWith(filterState.month));
             else if(filterState.type === 'year') data = data.filter(t => new Date(t.date).getFullYear() == filterState.year);

             if(data.length === 0) { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">No records.</p>'; return; }
             
             data.forEach(t => {
                 let color = t.type === 'income' ? 'text-emerald-600' : 'text-rose-600';
                 if(t.type === 'udhar') color = 'text-orange-500';
                 let sign = (t.type === 'income' || t.type === 'loan_taken') ? '+' : '-';
                 list.innerHTML += `<li class="p-4 border-b border-slate-50 last:border-b-0"><div class="flex flex-col w-full"><div class="flex justify-between items-start mb-2"><div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-sm text-slate-800">${t.desc}</span><span class="text-[9px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded uppercase">${t.type}</span></div><p class="text-xs text-slate-400">${t.note || '-'}</p></div><div class="text-right"><span class="font-bold text-base ${color} block">${sign}${formatter.format(t.amount)}</span></div></div><div class="flex justify-between items-center pt-2 border-t border-dashed border-slate-100 mt-1"><div class="text-[10px] text-slate-400 flex items-center gap-3 font-semibold"><span class="flex items-center gap-1"><i class="far fa-calendar"></i> ${t.date}</span></div><div class="flex gap-3 ml-3"><button onclick="deleteTransaction('${t.id}')" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button></div></div></div></li>`;
             });
        };

        window.updateChart = () => {
             const ctx = document.getElementById('expenseChart').getContext('2d');
             const currentMonth = new Date().toISOString().slice(0,7);
             let chartData = transactions.filter(t => t.type === 'expense');
             const now = new Date();
             if(homeFilter === 'monthly') chartData = chartData.filter(t => t.date.startsWith(now.toISOString().slice(0,7)));
             if(homeFilter === 'daily') chartData = chartData.filter(t => t.date === now.toISOString().split('T')[0]);
             if(homeFilter === 'yearly') chartData = chartData.filter(t => new Date(t.date).getFullYear() === now.getFullYear());

             const expenses = {};
             chartData.forEach(t => { expenses[t.desc] = (expenses[t.desc] || 0) + t.amount; });
             const total = Object.values(expenses).reduce((a,b)=>a+b, 0);
             document.getElementById('chart-total-center').innerText = formatter.format(total);

             if(chartInstance) chartInstance.destroy();
             chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(expenses), datasets: [{ data: Object.values(expenses), backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } });
             
             const legend = document.getElementById('analysis-legend');
             legend.innerHTML = '';
             Object.entries(expenses).sort((a,b)=>b[1]-a[1]).forEach(([k,v]) => {
                 const pct = total > 0 ? (v/total)*100 : 0;
                 const icon = catConfig[k] ? catConfig[k].icon : 'fa-circle';
                 const color = catConfig[k] ? catConfig[k].color : 'bg-gray-400';
                 legend.innerHTML += `<div class="flex justify-between items-center text-sm mb-1"><div class="flex items-center gap-3"><i class="fas ${icon} text-xs text-slate-400"></i><span class="font-bold text-slate-700 text-xs">${k}</span></div><div class="text-right"><span class="font-bold text-slate-800 text-xs">${formatter.format(v)}</span> <span class="text-[9px] text-slate-400">(${pct.toFixed(1)}%)</span></div></div><div class="w-full bg-slate-100 h-1 rounded-full mb-2"><div class="${color} h-1 rounded-full" style="width:${pct}%"></div></div>`;
             });
        };

        window.renderCustomerList = () => {
             const list = document.getElementById('udhar-list-container');
             list.innerHTML = '';
             const people = {};
             transactions.filter(t => t.isUdhar).forEach(t => {
                 if(!people[t.person]) people[t.person] = { name: t.person, bal: 0, last: t.date };
                 if(t.type === 'udhar') people[t.person].bal += t.amount;
                 else if(t.type === 'loan_taken') people[t.person].bal -= t.amount;
                 else if(t.isWusool) people[t.person].bal -= t.amount;
             });
             const sorted = Object.values(people).sort((a,b) => b.last.localeCompare(a.last));
             if(sorted.length === 0) { document.getElementById('no-udhar-msg').classList.remove('hidden'); return; }
             document.getElementById('no-udhar-msg').classList.add('hidden');
             sorted.forEach(p => {
                 const color = p.bal > 0 ? 'text-rose-600' : (p.bal < 0 ? 'text-blue-600' : 'text-slate-400');
                 list.innerHTML += `<div onclick="openPersonDetails('${p.name}')" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center active:scale-95 transition-transform"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold border border-slate-200">${p.name.charAt(0).toUpperCase()}</div><div><h4 class="font-bold text-slate-800 text-sm">${p.name}</h4><p class="text-[10px] text-slate-400">${timeAgo(p.last)}</p></div></div><div class="text-right"><span class="block font-black text-sm ${color}">${formatter.format(Math.abs(p.bal))}</span></div></div>`;
             });
        };

        // Populate Categories
        const sel = document.getElementById('tx-category');
        expenseCats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); });

    </script>
</body>
</html>